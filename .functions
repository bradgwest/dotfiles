#!/bin/bash

# ISO08061 UTC timestamp
timestamp() {
  date --utc +"%FZ%TZ"
}

# Write a notes taker
note() {
  # if $NOTES doesn't exist, then error
  if [ -z "${NOTES}" ]; then
    echo "Please set NOTES env variable"
    exit 1
  fi

  if ! (($#)); then
    # no args, tail
    tail $NOTES
  else
    # add all args to the file
    printf "$(timestamp) %s\n" "$*" >> $NOTES
  fi
}


# cd and ls in one
cl() {
  local dir="$1"
  local dir="${dir:=$HOME}"
  if [[ -d "$dir" ]]; then
    cd "$dir" >/dev/null; ls
  else
    echo "bash: cl: $dir: Directory not found"
  fi
}

# calculator
calc() {
    echo "scale=3;$@" | bc -l
}

# Take a TODO note in cwd
todo() {
    local dir="${PWD}/.todo"
    if [[ -z "$dir" ]]; then
        touch "$dir"
    fi

    if ! (($#)); then
        cat "$dir"
    else
        printf "$(timestamp) %s\n" "$*" >> "$dir"
    fi
}

# delete a line from $HISTFILE. If no arg is passed, then it deletes the
# previous command, otherwise it attempts to match the args to a line
forget() {
  if ! (($#)); then
    # no args, delete previous
    history -d $(expr $(history | tail -n 1 | grep -oP '^\s+\d+') - 1);
  else
    # implement me
    echo Not Implemented
  fi
}

# Create python3 venv in ./.venv
# $1 - path to python binary
# $2 - name of virtualenv
create_venv () {
  if [[ $# -ne 2 ]]; then
    echo "Must pass 2 parameters, (1) python binary and (2) name of venv"
    exit 1
  fi
  $1 -m venv $PWD/.venv/$2
  source $PWD/.venv/$2/bin/activate
  pip install wheel
}

# Create python2 venv in ./venv
# $1 - path to python binary
# $2 - name of virtualenv
create_venv2 () {
  if [[ $# -ne  2 ]]; then
    echo "Must pass 2 parameters, (1) python binary and (2) name of venv"
    return 1
  fi
  python2 -m virtualenv -p $1 $PWD/.venv/$2
}

# Activate a virtual env
# $1 path to venv, within .venv directory
venv () {
  local usage="Usage: venv <virtualenv>"

  if [[ ! -d .venv ]]; then
    echo "ERROR: .venv/ directory does not exist"
    return 1
  fi

  if [[ $# > 1 ]]; then
    echo "Too many args:\n$usage"
    return 1
  fi

  local subdirs=$(ls -d -- .venv/*/ | xargs basename)

  if [[ $# -eq 0 && $(echo $subdirs | wc -w) -ne 1 ]]; then
    echo "Virtualenvs in directory:\n$subdirs"
    return 0
  fi

  local venvpath=.venv/

  if [[ $# -eq 1 ]]; then
    venvpath+=$(echo $1 | sed 's/ *$//g')
  else
    venvpath+=$subdirs
  fi

  . ${venvpath}/bin/activate
}

